{% extends "base.html" %}
{% block content %}
<h1>All Habits</h1>

<table id="habitTable" border="1">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Name â¬</th>
      <th onclick="sortTable(1)">Periodicity â¬</th>
      <th>Details</th>
      <th onclick="sortTable(3)">Due â¬</th>
      <th onclick="sortTable(4)">Status â¬</th>
      <th onclick="sortTable(5)">Streak â¬</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for h in habits %}
    <tr>
      <td>{{ h["name"] }}</td>
      <td>{{ h["periodicity"] }}</td>
      <td><a href="{{ url_for('habit_detail', habit_id=h['id']) }}">ğŸ” Details</a></td>
      <td>{{ h["due_date"] }}</td>
      <td>
        {% if h["completed"] %}
          âœ… Completed
        {% else %}
          âŒ Broken
        {% endif %}
      </td>
      <td>{{ h["current_streak"] }}</td>
      <td>
        <a href="{{ url_for('complete', habit_id=h['id']) }}">âœ… Complete</a>
        <a href="{{ url_for('delete_habit_route', habit_id=h['id']) }}">ğŸ—‘ï¸ Delete</a>
        <a href="{{ url_for('edit_habit', habit_id=h['id']) }}">âœï¸ Edit</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
console.log("Sort function loaded!");

function sortTable(columnIndex) {
  console.log("Sorting column:", columnIndex);
  const table = document.getElementById("habitTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);

  // Check if already sorted â†’ reverse direction
  const currentSorted = table.getAttribute("data-sorted-column");
  const currentDirection = table.getAttribute("data-sort-direction");
  let direction = "asc";

  if (currentSorted == columnIndex.toString() && currentDirection === "asc") {
    direction = "desc";
  }

  // Save current sorted column & direction
  table.setAttribute("data-sorted-column", columnIndex);
  table.setAttribute("data-sort-direction", direction);

  // Helper function: detect data type
  function parseValue(val) {
    if (!val) return "";
    val = val.trim();

    // âœ… Convert emojis to numbers (for Status column)
    if (val.includes("âœ…")) return 1;
    if (val.includes("âŒ")) return 0;

    // â° Detect dates
    const date = Date.parse(val);
    if (!isNaN(date)) return date;

    // ğŸ”¢ Detect numbers
    if (!isNaN(val)) return parseFloat(val);

    // ğŸ”¤ Otherwise, text (lowercase)
    return val.toLowerCase();
  }

  rows.sort((a, b) => {
    const x = a.cells[columnIndex]?.textContent || "";
    const y = b.cells[columnIndex]?.textContent || "";
    const xVal = parseValue(x);
    const yVal = parseValue(y);

    if (xVal < yVal) return direction === "asc" ? -1 : 1;
    if (xVal > yVal) return direction === "asc" ? 1 : -1;
    return 0;
  });

  // Remove old rows & append sorted rows
  tbody.innerHTML = "";
  rows.forEach(row => tbody.appendChild(row));
}
</script>

{% endblock %}
